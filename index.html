<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>×¨×™×©×•× × ×•×›×—×•×ª ×œ×¢×•×‘×“×™× - ××›×œ×œ×ª ×”×‘×•× ×™× ×‘×¢"×</title>

  <style>
    :root{
      --bg:#f4f6f8;
      --bg2:#eef1f4;
      --card:#ffffff;
      --line:#d9dee6;
      --text:#1f2937;
      --muted:#6b7280;
      --btn:#111827;
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#b45309;
      --shadow: 0 14px 34px rgba(17,24,39,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(0,0,0,.04), transparent 60%),
        radial-gradient(800px 480px at 90% 10%, rgba(0,0,0,.03), transparent 55%),
        linear-gradient(180deg,var(--bg),var(--bg2));
      min-height:100vh;
      line-height:1.45;
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px 14px 110px}
    .brand{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:16px}
    .brand h1{font-size:19px;line-height:1.25;margin:0}
    .brand small{display:block;color:var(--muted);margin-top:8px;font-size:13px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:9px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:#111827;font-size:12px;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    h2{font-size:16px;margin:6px 0 12px}
    h3{font-size:14px;margin:14px 0 10px}
    label{display:block;font-size:13px;margin:12px 0 6px;color:#111827}
    input,select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    input::placeholder{color:#9ca3af}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1 1 220px;min-width:220px}
    @media (max-width:720px){
      .row > *{min-width:unset;flex:1 1 160px}
    }
    .btn{
      width:100%;
      padding:12px 14px;
      border:0;
      border-radius:14px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{background:var(--btn); color:white}
    .btn.ghost{background:#fff;color:var(--btn);border:1px solid var(--line)}
    .btn.ok{background:var(--ok);color:white}
    .btn.bad{background:var(--bad);color:white}
    .btn.warn{background:var(--warn);color:white}

    .note{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      background:#f9fafb;
      border:1px solid var(--line);
    }
    .hidden{display:none !important}
    .kpi{display:flex;gap:12px;margin:12px 0;flex-wrap:wrap}
    .kpi .box{
      flex:1 1 220px;
      background:#fff;border:1px solid var(--line);
      border-radius:14px;padding:12px;
      min-width:220px;
    }
    .kpi .v{font-size:18px;font-weight:900}
    .kpi .t{font-size:12px;color:var(--muted);margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);font-size:13px;text-align:right;vertical-align:top}
    th{color:#111827;font-weight:900;background:#f9fafb}
    .dangerText{color:#b91c1c;margin:10px 0 0}
    .okText{color:#166534;margin:10px 0 0}
    .muted{color:var(--muted);font-size:12px;line-height:1.5}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .footerActions{
      position:fixed;bottom:0;left:0;right:0;
      padding:10px 12px;
      background:rgba(244,246,248,.88);
      backdrop-filter: blur(12px);
      border-top:1px solid var(--line);
    }
    .footerActions .wrap2{max-width:980px;margin:0 auto}
    .tag{
      display:inline-block;border:1px solid var(--line);background:#fff;border-radius:999px;
      padding:5px 10px;font-size:12px;color:#111827;
      white-space:nowrap;
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tabs .btn{max-width:220px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brand">
      <div>
        <h1>×¨×™×©×•× × ×•×›×—×•×ª ×œ×¢×•×‘×“×™× - ××›×œ×œ×ª ×”×‘×•× ×™× ×‘×¢"×</h1>
        <small>×›× ×™×¡×”/×™×¦×™××” ×™×•××™×ª</small>
      </div>
      <div id="roleBadge" class="badge hidden">ğŸ›¡ï¸ ×× ×”×œ</div>
    </div>

    <div id="loginCard" class="card">
      <h2>×”×ª×—×‘×¨×•×ª</h2>

      <label>××™×™×œ</label>
      <input id="email" dir="ltr" type="email" placeholder="name@company.com" autocomplete="username" />

      <label>×¡×™×¡××”</label>
      <input id="password" dir="ltr" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnEmailLogin">×”×ª×—×‘×¨/×™</button>
      </div>

      <p id="loginMsg" class="dangerText"></p>
    </div>

    <div id="employeeCard" class="card hidden">
      <h2>××¡×š ×¢×•×‘×“</h2>

      <div class="kpi">
        <div class="box">
          <div class="v" id="kpiName">â€”</div>
          <div class="t">×©× ××œ×</div>
        </div>
        <div class="box">
          <div class="v" id="kpiHours">0:00</div>
          <div class="t">×©×¢×•×ª ×”×—×•×“×© ×¢×“ ×¢×›×©×™×•</div>
        </div>
      </div>

      <div class="note">
        <div><b>××™×™×œ:</b> <span id="pEmail">â€”</span></div>
        <div style="margin-top:6px"><b>×˜×œ×¤×•×Ÿ:</b> <span id="pPhone">â€”</span></div>
        <div class="divider"></div>
        <div><b>×¡×˜×˜×•×¡ ×¢×•×‘×“:</b> <span id="pStatus" class="tag">â€”</span></div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn ok" id="btnIn">×›× ×™×¡×”</button>
        <button class="btn bad" id="btnOut">×™×¦×™××”</button>
      </div>

      <p id="empMsg" class="dangerText"></p>
      <p id="empOk" class="okText"></p>
    </div>

    <div id="adminCard" class="card hidden">
      <h2>××¡×š ×× ×”×œ</h2>

      <div class="note">
        <div class="tabs">
          <button class="btn ghost" id="tabUsers">×¢×•×‘×“×™×</button>
          <button class="btn ghost" id="tabReports">×“×•×—×•×ª</button>
        </div>
      </div>

      <div id="usersTab" class="note">
        <h3>× ×™×”×•×œ ×¢×•×‘×“×™×</h3>

        <div class="grid2">
          <div>
            <label>×‘×—×¨ ×¢×•×‘×“</label>
            <select id="userSelectManage"></select>
            <div class="muted" style="margin-top:10px">
              ×™×¦×™×¨×ª ××©×ª××© ×—×“×© (××™×™×œ+×¡×™×¡××”) × ×¢×©×™×ª ×‘-Firebase â†’ Authentication â†’ Users â†’ Add user.<br>
              ×›××Ÿ ×× ×”×œ×™× ×¤×¨×˜×™× ×•×”×©×‘×ª×” ××ª×•×š ×”××¤×œ×™×§×¦×™×”.
            </div>
          </div>

          <div>
            <label>×¡×˜×˜×•×¡</label>
            <div class="row">
              <div class="tag" id="manageStatusTag">â€”</div>
              <button class="btn warn" id="btnToggleDisable">×”×©×‘×ª/×”×¤×¢×œ</button>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:6px">
          <div>
            <label>×©× ××œ×</label>
            <input id="manageFullName" placeholder="×™×©×¨××œ ×™×©×¨××œ×™" />
          </div>
          <div>
            <label>×˜×œ×¤×•×Ÿ</label>
            <input id="managePhone" dir="ltr" placeholder="0501234567" />
          </div>
        </div>

        <div class="grid2" style="margin-top:6px">
          <div>
            <label>××™×™×œ</label>
            <input id="manageEmail" dir="ltr" placeholder="employee@company.com" disabled />
            <div class="muted" style="margin-top:6px">×”××™×™×œ ××’×™×¢ ×-Firebase Auth ×•×œ×›×Ÿ ×œ×§×¨×™××” ×‘×œ×‘×“.</div>
          </div>
          <div>
            <label>×ª×¤×§×™×“</label>
            <select id="manageRole">
              <option value="employee">×¢×•×‘×“</option>
              <option value="admin">×× ×”×œ</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <button class="btn primary" id="btnSaveUser">×©××•×¨ ×¤×¨×˜×™×</button>
          <button class="btn ghost" id="btnReloadUsers">×¨×¢× ×Ÿ ×¨×©×™××”</button>
        </div>

        <p id="usersMsg" class="dangerText"></p>
        <p id="usersOk" class="okText"></p>

        <div class="divider"></div>

        <h3>×¨×©×™××ª ×¢×•×‘×“×™×</h3>
        <div style="overflow:auto">
          <table id="usersTable">
            <thead>
              <tr>
                <th>×©×</th>
                <th>××™×™×œ</th>
                <th>×˜×œ×¤×•×Ÿ</th>
                <th>×ª×¤×§×™×“</th>
                <th>×¡×˜×˜×•×¡</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="reportsTab" class="note hidden">
        <h3>×“×•×—×•×ª × ×•×›×—×•×ª</h3>

        <div class="row">
          <div>
            <label>××ª××¨×™×š</label>
            <input id="fromDate" type="date" />
          </div>
          <div>
            <label>×¢×“ ×ª××¨×™×š</label>
            <input id="toDate" type="date" />
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div>
            <label>×¢×•×‘×“</label>
            <select id="userSelectReport"></select>
            <div class="muted" style="margin-top:6px">×‘×—×¨/×™ â€œ×›×•×œ×â€ ×œ×“×•×— ×›×•×œ×œ.</div>
          </div>
          <div>
            <button class="btn primary" id="btnLoadReport">×”×¤×§ ×“×•×—</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn ghost" id="btnExportCsv">×™×™×¦×•× ×œ-Excel (CSV)</button>
          <button class="btn ghost" id="btnExportPdf">×™×™×¦×•× ×œ-PDF</button>
        </div>

        <p id="adminMsg" class="dangerText"></p>
        <p id="adminOk" class="okText"></p>

        <div class="kpi">
          <div class="box">
            <div class="v" id="kpiRows">0</div>
            <div class="t">×¨×©×•××•×ª</div>
          </div>
          <div class="box">
            <div class="v" id="kpiTotal">0:00</div>
            <div class="t">×¡×š ×©×¢×•×ª ×‘×“×•×—</div>
          </div>
        </div>

        <div style="overflow:auto">
          <table id="reportTable">
            <thead>
              <tr>
                <th>×¢×•×‘×“</th>
                <th>×ª××¨×™×š</th>
                <th>×›× ×™×¡×”</th>
                <th>×™×¦×™××”</th>
                <th>×¡×”×´×›</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- âœ… ×—×“×©: ×ª×™×§×•×Ÿ × ×•×›×—×•×ª (×œ×× ×”×œ ×‘×œ×‘×“) -->
        <div class="divider"></div>
        <h3>×ª×™×§×•×Ÿ × ×•×›×—×•×ª (×× ×”×œ ×‘×œ×‘×“)</h3>

        <div class="grid2">
          <div>
            <label>×‘×—×¨ ×¢×•×‘×“</label>
            <select id="fixUserSelect"></select>
            <div class="muted" style="margin-top:6px">
              ×›××Ÿ ××¤×©×¨ ×œ×ª×§×Ÿ ×›× ×™×¡×”/×™×¦×™××” ×œ×ª××¨×™×š ××¡×•×™× (×œ××©×œ: ×¢×•×‘×“ ×©×›×— ×œ×¡××Ÿ ×™×¦×™××”).
            </div>
          </div>

          <div>
            <label>×ª××¨×™×š</label>
            <input id="fixDate" type="date" />
            <div class="muted" style="margin-top:6px">×‘×¨×™×¨×ª ××—×“×œ: ××ª××•×œ.</div>
          </div>
        </div>

        <div class="grid2" style="margin-top:6px">
          <div>
            <label>×©×¢×ª ×›× ×™×¡×” (HH:MM)</label>
            <input id="fixInTime" dir="ltr" inputmode="numeric" placeholder="08:00" />
          </div>
          <div>
            <label>×©×¢×ª ×™×¦×™××” (HH:MM)</label>
            <input id="fixOutTime" dir="ltr" inputmode="numeric" placeholder="16:00" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn ghost" id="btnLoadFix">×˜×¢×Ÿ ×¨×©×•××”</button>
          <button class="btn primary" id="btnSaveFix">×©××•×¨ ×ª×™×§×•×Ÿ</button>
          <button class="btn warn" id="btnClearOut">× ×§×” ×™×¦×™××”</button>
        </div>

        <p id="fixMsg" class="dangerText"></p>
        <p id="fixOk" class="okText"></p>

      </div>
    </div>

    <div class="footerActions">
      <div class="wrap2">
        <div class="row">
          <button class="btn ghost" id="btnRefresh">×¨×¢× ×•×Ÿ</button>
          <button class="btn ghost" id="btnLogout">×”×ª× ×ª×§×•×ª</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
      collection, getDocs, query, where, orderBy, Timestamp, collectionGroup
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBpoCWqanFcP7pU8pmosmYSPU920D0lrY",
      authDomain: "attendance-habonim.firebaseapp.com",
      projectId: "attendance-habonim",
      storageBucket: "attendance-habonim.firebasestorage.app",
      messagingSenderId: "40149861354",
      appId: "1:40149861354:web:0f865b122316bb6b3a2893"
    };

    const ADMIN_EMAILS = [
      "itzik@bonima.co.il",
      "office.bonim353@gmail.com"
    ].map(e => String(e).trim().toLowerCase());

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    function cleanEmail(raw){
      return String(raw || "")
        .trim()
        .replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g, "")
        .replace(/\s+/g, "");
    }
    function isAdminEmail(email){
      if(!email) return false;
      return ADMIN_EMAILS.includes(String(email).trim().toLowerCase());
    }
    function setMode(mode){
      hide($("loginCard")); hide($("employeeCard")); hide($("adminCard")); hide($("roleBadge"));
      if(mode === "login") show($("loginCard"));
      if(mode === "employee") show($("employeeCard"));
      if(mode === "admin"){ show($("adminCard")); show($("roleBadge")); }
    }

    const pad2 = (n)=> String(n).padStart(2,"0");
    const ymd = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const fmtTime = (d)=> new Intl.DateTimeFormat("he-IL",{hour:"2-digit",minute:"2-digit"}).format(d);
    function msToHHMM(ms){
      const totalMin = Math.floor(ms/60000);
      const h = Math.floor(totalMin/60);
      const m = totalMin%60;
      return `${h}:${pad2(m)}`;
    }
    function tsToDate(ts){
      if(!ts) return null;
      return (ts instanceof Timestamp) ? ts.toDate() : null;
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // === ×—×“×©: ×¢×–×¨×™× ×œ×ª×™×§×•×Ÿ ×©×¢×•×ª ===
    function normalizeHHMM(v){
      const s = String(v||"").trim();
      if(!s) return "";
      // ×××¤×©×¨ ×’× 8:5 => 08:05
      const m = s.match(/^(\d{1,2}):(\d{1,2})$/);
      if(!m) return "";
      const hh = Number(m[1]), mm = Number(m[2]);
      if(!Number.isFinite(hh) || !Number.isFinite(mm)) return "";
      if(hh < 0 || hh > 23 || mm < 0 || mm > 59) return "";
      return `${pad2(hh)}:${pad2(mm)}`;
    }

    function combineDateAndTime(dateYMD, hhmm){
      const t = normalizeHHMM(hhmm);
      if(!dateYMD || !t) return null;
      const [H, M] = t.split(":").map(Number);
      // Date ××§×•××™ (×©×¢×•×Ÿ ×™×©×¨××œ ×©×œ ×”××©×ª××© ×‘××›×©×™×¨)
      return new Date(`${dateYMD}T${pad2(H)}:${pad2(M)}:00`);
    }

    // ===== Profiles =====
    async function ensureProfile(user){
      const role = (user.email && isAdminEmail(user.email)) ? "admin" : "employee";
      const uref = doc(db, "users", user.uid);
      const snap = await getDoc(uref);

      const defaultName = (() => {
        if (user.displayName) return user.displayName;
        if (user.email && user.email.includes("@")) return user.email.split("@")[0];
        return "×¢×•×‘×“/×ª";
      })();

      if(!snap.exists()){
        const profile = {
          fullName: defaultName,
          email: user.email || "",
          phone: user.phoneNumber || "",
          role,
          status: "active",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        await setDoc(uref, profile, { merge:true });
        return profile;
      }

      const profile = snap.data();
      const patch = {};
      if(profile.role !== role) patch.role = role;
      if(!profile.email && user.email) patch.email = user.email;
      if(!profile.fullName) patch.fullName = defaultName;
      if(!profile.status) patch.status = "active";

      if(Object.keys(patch).length){
        patch.updatedAt = serverTimestamp();
        await updateDoc(uref, patch);
        return { ...profile, ...patch, role };
      }
      return profile;
    }

    // âœ… × ×•×›×—×•×ª × ×©××¨×ª ×‘×ª×•×š ×”××©×ª××©:
    // users/{uid}/attendance/{YYYY-MM-DD}
    function attendanceRef(uid, dateYMD){
      return doc(db, "users", uid, "attendance", dateYMD);
    }
    function todayAttendanceRef(uid){
      return attendanceRef(uid, ymd(new Date()));
    }

    async function punch(type, user, profile){
      const aref = todayAttendanceRef(user.uid);
      const snap = await getDoc(aref);
      const now = serverTimestamp();

      if(!snap.exists()){
        await setDoc(aref, {
          uid: user.uid,
          employeeName: profile.fullName || "",
          dateYMD: ymd(new Date()),
          inAt: type === "in" ? now : null,
          outAt: type === "out" ? now : null,
          updatedAt: now
        }, { merge:true });
        return;
      }

      const data = snap.data();
      if(type === "in"){
        if(data.inAt) throw new Error("×›×‘×¨ ×‘×•×¦×¢×” ×›× ×™×¡×” ×”×™×•×.");
        await updateDoc(aref, { inAt: now, updatedAt: now, employeeName: profile.fullName || "" });
      } else {
        if(!data.inAt) throw new Error("××™×Ÿ ×›× ×™×¡×” ×”×™×•×. × × ×œ×‘×¦×¢ ×›× ×™×¡×” ×§×•×“×.");
        if(data.outAt) throw new Error("×›×‘×¨ ×‘×•×¦×¢×” ×™×¦×™××” ×”×™×•×.");
        await updateDoc(aref, { outAt: now, updatedAt: now, employeeName: profile.fullName || "" });
      }
    }

    async function calcMonthHours(uid, year, monthIndex){
      const start = new Date(year, monthIndex, 1, 0,0,0,0);
      const end = new Date(year, monthIndex+1, 1, 0,0,0,0);
      const fromY = ymd(start);
      const toY = ymd(new Date(end.getTime()-1));

      const qy = query(
        collection(db, "users", uid, "attendance"),
        where("dateYMD", ">=", fromY),
        where("dateYMD", "<=", toY),
        orderBy("dateYMD","asc")
      );

      const snap = await getDocs(qy);
      let totalMs = 0;
      snap.forEach(docu=>{
        const d = docu.data();
        const inD = tsToDate(d.inAt);
        const outD = tsToDate(d.outAt);
        if(inD && outD) totalMs += Math.max(0, outD - inD);
      });
      return totalMs;
    }

    async function refreshEmployeeUI(user, profile){
      $("kpiName").textContent = profile.fullName || "â€”";
      $("pEmail").textContent = profile.email || user.email || "â€”";
      $("pPhone").textContent = profile.phone || user.phoneNumber || "â€”";
      $("pStatus").textContent = (profile.status === "disabled") ? "××•×©×‘×ª" : "×¤×¢×™×œ";

      const now = new Date();
      const ms = await calcMonthHours(user.uid, now.getFullYear(), now.getMonth());
      $("kpiHours").textContent = msToHHMM(ms);
    }

    // ===== ADMIN: Users =====
    let usersCache = [];

    function fillSelectManage(){
      const sel = $("userSelectManage");
      sel.innerHTML = "";
      for(const u of usersCache){
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${u.data.fullName || u.data.email || u.id}`;
        sel.appendChild(opt);
      }
    }
    function fillSelectReport(){
      const sel = $("userSelectReport");
      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "__ALL__";
      optAll.textContent = "×›×•×œ×";
      sel.appendChild(optAll);

      for(const u of usersCache){
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${u.data.fullName || u.data.email || u.id}`;
        sel.appendChild(opt);
      }
    }

    // âœ… ×—×“×©: dropdown ×œ×ª×™×§×•×Ÿ
    function fillSelectFix(){
      const sel = $("fixUserSelect");
      sel.innerHTML = "";
      for(const u of usersCache){
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${u.data.fullName || u.data.email || u.id}`;
        sel.appendChild(opt);
      }
    }

    function renderUsersTable(){
      const tb = $("usersTable").querySelector("tbody");
      tb.innerHTML = "";
      for(const u of usersCache){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(u.data.fullName||"")}</td>
          <td dir="ltr">${escapeHtml(u.data.email||"")}</td>
          <td dir="ltr">${escapeHtml(u.data.phone||"")}</td>
          <td>${escapeHtml(u.data.role||"employee")}</td>
          <td>${(u.data.status==="disabled") ? "××•×©×‘×ª" : "×¤×¢×™×œ"}</td>
        `;
        tb.appendChild(tr);
      }
    }

    async function loadAllUsers(){
      const snap = await getDocs(collection(db,"users"));
      usersCache = [];
      snap.forEach(d=> usersCache.push({ id:d.id, data:d.data() }));
      usersCache.sort((a,b)=> String(a.data.fullName||"").localeCompare(String(b.data.fullName||""), "he"));
      fillSelectManage();
      fillSelectReport();
      fillSelectFix();
      renderUsersTable();

      if(usersCache.length){
        $("userSelectManage").value = usersCache[0].id;
        loadSelectedUserToForm();

        $("fixUserSelect").value = usersCache[0].id;
      }
    }

    function loadSelectedUserToForm(){
      const uid = $("userSelectManage").value;
      const found = usersCache.find(u=>u.id===uid);
      if(!found) return;

      $("manageFullName").value = found.data.fullName || "";
      $("managePhone").value = found.data.phone || "";
      $("manageEmail").value = found.data.email || "";
      $("manageRole").value = found.data.role || "employee";

      const disabled = found.data.status === "disabled";
      $("manageStatusTag").textContent = disabled ? "××•×©×‘×ª" : "×¤×¢×™×œ";
      $("btnToggleDisable").textContent = disabled ? "×”×¤×¢×œ ×¢×•×‘×“" : "×”×©×‘×ª ×¢×•×‘×“";
    }

    async function saveUser(){
      $("usersMsg").textContent = "";
      $("usersOk").textContent = "";

      const uid = $("userSelectManage").value;
      const fullName = ($("manageFullName").value||"").trim();
      const phone = ($("managePhone").value||"").trim();
      const role = $("manageRole").value;

      if(!uid) return $("usersMsg").textContent = "×‘×—×¨ ×¢×•×‘×“.";
      if(!fullName) return $("usersMsg").textContent = "× × ×œ××œ× ×©× ××œ×.";

      try{
        await updateDoc(doc(db,"users",uid), {
          fullName, phone, role,
          updatedAt: serverTimestamp()
        });
        $("usersOk").textContent = "âœ… × ×©××¨";
        await loadAllUsers();
        $("userSelectManage").value = uid;
        loadSelectedUserToForm();
      }catch(e){
        $("usersMsg").textContent = e.message || String(e);
      }
    }

    async function toggleDisable(){
      $("usersMsg").textContent = "";
      $("usersOk").textContent = "";

      const uid = $("userSelectManage").value;
      const found = usersCache.find(u=>u.id===uid);
      if(!found) return;

      const newStatus = (found.data.status === "disabled") ? "active" : "disabled";

      try{
        await updateDoc(doc(db,"users",uid), {
          status: newStatus,
          updatedAt: serverTimestamp()
        });
        $("usersOk").textContent = (newStatus==="disabled") ? "âœ… ×¢×•×‘×“ ×”×•×©×‘×ª" : "âœ… ×¢×•×‘×“ ×”×•×¤×¢×œ";
        await loadAllUsers();
        $("userSelectManage").value = uid;
        loadSelectedUserToForm();
      }catch(e){
        $("usersMsg").textContent = e.message || String(e);
      }
    }

    // ===== ADMIN: Reports =====
    let lastReportRows = [];

    async function buildReport({from, to, uidOrAll}){
      const fromY = ymd(from);
      const toY = ymd(to);

      let qy;
      if(uidOrAll === "__ALL__"){
        qy = query(
          collectionGroup(db, "attendance"),
          where("dateYMD", ">=", fromY),
          where("dateYMD", "<=", toY),
          orderBy("dateYMD","asc")
        );
      } else {
        qy = query(
          collection(db, "users", uidOrAll, "attendance"),
          where("dateYMD", ">=", fromY),
          where("dateYMD", "<=", toY),
          orderBy("dateYMD","asc")
        );
      }

      const snap = await getDocs(qy);
      const rows = [];
      let totalMs = 0;

      snap.forEach(docu=>{
        const d = docu.data();
        const inD = tsToDate(d.inAt);
        const outD = tsToDate(d.outAt);
        const ms = (inD && outD) ? Math.max(0, outD - inD) : 0;
        totalMs += ms;

        rows.push({
          employeeName: d.employeeName || d.uid,
          date: d.dateYMD,
          inAt: inD ? fmtTime(inD) : "",
          outAt: outD ? fmtTime(outD) : "",
          total: ms ? msToHHMM(ms) : ""
        });
      });

      return { rows, totalMs };
    }

    function renderReport(rows, totalMs){
      lastReportRows = rows;
      $("kpiRows").textContent = String(rows.length);
      $("kpiTotal").textContent = msToHHMM(totalMs);

      const tb = $("reportTable").querySelector("tbody");
      tb.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.employeeName)}</td>
          <td>${escapeHtml(r.date)}</td>
          <td>${escapeHtml(r.inAt)}</td>
          <td>${escapeHtml(r.outAt)}</td>
          <td>${escapeHtml(r.total)}</td>
        `;
        tb.appendChild(tr);
      }
    }

    function downloadText(filename, text, mime="text/plain"){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCSV(){
      const header = ["Employee","Date","In","Out","Total"];
      const lines = [header.join(",")];
      for(const r of lastReportRows){
        const line = [r.employeeName, r.date, r.inAt, r.outAt, r.total]
          .map(v => `"${String(v||"").replaceAll('"','""')}"`).join(",");
        lines.push(line);
      }
      downloadText(`attendance_${Date.now()}.csv`, lines.join("\n"), "text/csv;charset=utf-8");
    }

    async function exportPDF(){
      const { jsPDF } = await import("https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js");
      await import("https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js");

      const pdf = new jsPDF({ orientation:"portrait", unit:"pt", format:"a4" });
      pdf.setFontSize(14);
      pdf.text("×“×•×— × ×•×›×—×•×ª - ××›×œ×œ×ª ×”×‘×•× ×™× ×‘×¢\"×", 40, 40);

      const body = lastReportRows.map(r => [r.employeeName, r.date, r.inAt, r.outAt, r.total]);
      pdf.autoTable({
        startY: 60,
        head: [["×¢×•×‘×“","×ª××¨×™×š","×›× ×™×¡×”","×™×¦×™××”","×¡×”×´×›"]],
        body,
        styles: { fontSize: 9 },
      });

      pdf.save(`attendance_${Date.now()}.pdf`);
    }

    function setDefaultDates(){
      const now = new Date();
      const first = new Date(now.getFullYear(), now.getMonth(), 1);
      const last = new Date(now.getFullYear(), now.getMonth()+1, 0);
      $("fromDate").value = ymd(first);
      $("toDate").value = ymd(last);

      // âœ… ×—×“×©: ×ª×™×§×•×Ÿ ×‘×¨×™×¨×ª ××—×“×œ = ××ª××•×œ
      const y = new Date(now);
      y.setDate(now.getDate() - 1);
      $("fixDate").value = ymd(y);
    }

    function showUsersTab(){ show($("usersTab")); hide($("reportsTab")); }
    function showReportsTab(){ hide($("usersTab")); show($("reportsTab")); }

    // ===== ADMIN: Fix Attendance =====
    function clearFixMessages(){
      $("fixMsg").textContent = "";
      $("fixOk").textContent = "";
    }

    async function loadFixRecord(){
      clearFixMessages();

      const uid = $("fixUserSelect").value;
      const dateYMD = $("fixDate").value;

      if(!uid) return $("fixMsg").textContent = "×‘×—×¨ ×¢×•×‘×“ ×œ×ª×™×§×•×Ÿ.";
      if(!dateYMD) return $("fixMsg").textContent = "×‘×—×¨ ×ª××¨×™×š.";

      try{
        const aref = attendanceRef(uid, dateYMD);
        const snap = await getDoc(aref);

        if(!snap.exists()){
          $("fixInTime").value = "";
          $("fixOutTime").value = "";
          $("fixOk").textContent = "â„¹ï¸ ××™×Ÿ ×¨×©×•××” ×œ×ª××¨×™×š ×”×–×” (××¤×©×¨ ×œ×™×¦×•×¨ ×‘×××¦×¢×•×ª ×©××™×¨×”).";
          return;
        }

        const d = snap.data();
        const inD = tsToDate(d.inAt);
        const outD = tsToDate(d.outAt);

        $("fixInTime").value = inD ? `${pad2(inD.getHours())}:${pad2(inD.getMinutes())}` : "";
        $("fixOutTime").value = outD ? `${pad2(outD.getHours())}:${pad2(outD.getMinutes())}` : "";

        $("fixOk").textContent = "âœ… ×”×¨×©×•××” × ×˜×¢× ×”.";
      }catch(e){
        $("fixMsg").textContent = e.message || String(e);
      }
    }

    async function saveFixRecord(){
      clearFixMessages();

      const uid = $("fixUserSelect").value;
      const dateYMD = $("fixDate").value;
      const inTimeRaw = $("fixInTime").value;
      const outTimeRaw = $("fixOutTime").value;

      if(!uid) return $("fixMsg").textContent = "×‘×—×¨ ×¢×•×‘×“ ×œ×ª×™×§×•×Ÿ.";
      if(!dateYMD) return $("fixMsg").textContent = "×‘×—×¨ ×ª××¨×™×š.";

      const inNorm = normalizeHHMM(inTimeRaw);
      const outNorm = normalizeHHMM(outTimeRaw);

      if(inTimeRaw && !inNorm) return $("fixMsg").textContent = "×©×¢×ª ×›× ×™×¡×” ×œ× ×ª×§×™× ×”. ×“×•×’××”: 08:00";
      if(outTimeRaw && !outNorm) return $("fixMsg").textContent = "×©×¢×ª ×™×¦×™××” ×œ× ×ª×§×™× ×”. ×“×•×’××”: 16:00";

      // ×× ××™×œ××• ×’× ×•×’× â€” × ×•×•×“× ×”×’×™×•×Ÿ
      if(inNorm && outNorm){
        const inD = combineDateAndTime(dateYMD, inNorm);
        const outD = combineDateAndTime(dateYMD, outNorm);
        if(inD && outD && outD < inD){
          return $("fixMsg").textContent = "×©×¢×ª ×™×¦×™××” ×œ× ×™×›×•×œ×” ×œ×”×™×•×ª ×œ×¤× ×™ ×©×¢×ª ×›× ×™×¡×”.";
        }
      }

      try{
        const aref = attendanceRef(uid, dateYMD);
        const snap = await getDoc(aref);

        const foundUser = usersCache.find(u=>u.id===uid);
        const employeeName = foundUser?.data?.fullName || foundUser?.data?.email || uid;

        // × ×©××•×¨ ×¨×§ ××” ×©× ×™×ª×Ÿ (×©×“×•×ª ×¨×™×§×™× -> ×œ× ××©× ×™×)
        const patch = {
          uid,
          employeeName,
          dateYMD,
          updatedAt: serverTimestamp()
        };

        if(inNorm){
          const inD = combineDateAndTime(dateYMD, inNorm);
          patch.inAt = Timestamp.fromDate(inD);
        }
        if(outNorm){
          const outD = combineDateAndTime(dateYMD, outNorm);
          patch.outAt = Timestamp.fromDate(outD);
        }

        if(!snap.exists()){
          // ×™×¦×™×¨×ª ×¨×©×•××” ×—×“×©×” â€” merge ×›×“×™ ×œ×”×™×•×ª ×‘×˜×•×—×™×
          await setDoc(aref, {
            ...patch,
            inAt: patch.inAt ?? null,
            outAt: patch.outAt ?? null
          }, { merge:true });
          $("fixOk").textContent = "âœ… × ×•×¦×¨×”/× ×©××¨×” ×¨×©×•××” ×—×“×©×” ×œ×ª××¨×™×š ×”×–×”.";
          return;
        }

        // ×× ×§×™×™××ª â€” merge/×¢×“×›×•×Ÿ × ×§×•×“×ª×™ (×‘×œ×™ ×œ××—×•×§ ×©×“×•×ª ××—×¨×™×)
        await setDoc(aref, patch, { merge:true });
        $("fixOk").textContent = "âœ… ×”×ª×™×§×•×Ÿ × ×©××¨ (×‘×œ×™ ×œ××—×•×§ × ×ª×•× ×™× ××—×¨×™×).";
      }catch(e){
        $("fixMsg").textContent = e.message || String(e);
      }
    }

    async function clearOutTime(){
      clearFixMessages();

      const uid = $("fixUserSelect").value;
      const dateYMD = $("fixDate").value;

      if(!uid) return $("fixMsg").textContent = "×‘×—×¨ ×¢×•×‘×“ ×œ×ª×™×§×•×Ÿ.";
      if(!dateYMD) return $("fixMsg").textContent = "×‘×—×¨ ×ª××¨×™×š.";

      try{
        const aref = attendanceRef(uid, dateYMD);
        const snap = await getDoc(aref);
        if(!snap.exists()){
          $("fixMsg").textContent = "××™×Ÿ ×¨×©×•××” ×œ×ª××¨×™×š ×”×–×”, ××™×Ÿ ××” ×œ× ×§×•×ª.";
          return;
        }
        await updateDoc(aref, { outAt: null, updatedAt: serverTimestamp() });
        $("fixOutTime").value = "";
        $("fixOk").textContent = "âœ… ×™×¦×™××” × ×•×§×ª×”.";
      }catch(e){
        $("fixMsg").textContent = e.message || String(e);
      }
    }

    // ===== Login / Buttons =====
    $("btnEmailLogin").onclick = async () => {
      $("loginMsg").textContent = "";
      const email = cleanEmail($("email").value);
      const password = $("password").value;

      if(!email || !password){
        $("loginMsg").textContent = "× × ×œ××œ× ××™×™×œ ×•×¡×™×¡××”.";
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        const code = e?.code ? `(${e.code}) ` : "";
        $("loginMsg").textContent = `×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ${code}${e.message || e}`;
      }
    };

    $("btnLogout").onclick = async () => { await signOut(auth); };
    $("btnRefresh").onclick = async () => { location.reload(); };

    $("btnIn").onclick = async () => {
      $("empMsg").textContent = "";
      $("empOk").textContent = "";
      const user = auth.currentUser;
      if(!user) return;

      try{
        const profile = (await getDoc(doc(db,"users",user.uid))).data();
        if(profile?.status === "disabled"){
          $("empMsg").textContent = "×”××©×ª××© ××•×©×‘×ª. ×¤× ×” ×œ×× ×”×œ.";
          return;
        }
        await punch("in", user, profile);
        await refreshEmployeeUI(user, profile);
        $("empOk").textContent = "âœ… ×›× ×™×¡×” × ×¨×©××”";
      } catch(e){
        $("empMsg").textContent = e.message || String(e);
      }
    };

    $("btnOut").onclick = async () => {
      $("empMsg").textContent = "";
      $("empOk").textContent = "";
      const user = auth.currentUser;
      if(!user) return;

      try{
        const profile = (await getDoc(doc(db,"users",user.uid))).data();
        if(profile?.status === "disabled"){
          $("empMsg").textContent = "×”××©×ª××© ××•×©×‘×ª. ×¤× ×” ×œ×× ×”×œ.";
          return;
        }
        await punch("out", user, profile);
        await refreshEmployeeUI(user, profile);
        $("empOk").textContent = "âœ… ×™×¦×™××” × ×¨×©××”";
      } catch(e){
        $("empMsg").textContent = e.message || String(e);
      }
    };

    $("tabUsers").onclick = showUsersTab;
    $("tabReports").onclick = showReportsTab;

    $("btnReloadUsers").onclick = async () => {
      $("usersMsg").textContent = "";
      $("usersOk").textContent = "";
      try{
        await loadAllUsers();
        $("usersOk").textContent = "âœ… ×¢×•×“×›×Ÿ";
      }catch(e){
        $("usersMsg").textContent = e.message || String(e);
      }
    };

    $("userSelectManage").onchange = loadSelectedUserToForm;
    $("btnSaveUser").onclick = saveUser;
    $("btnToggleDisable").onclick = toggleDisable;

    $("btnLoadReport").onclick = async () => {
      $("adminMsg").textContent = "";
      $("adminOk").textContent = "";

      try{
        const fromVal = $("fromDate").value;
        const toVal = $("toDate").value;
        const uid = $("userSelectReport").value;

        if(!fromVal || !toVal){
          $("adminMsg").textContent = "× × ×œ×‘×—×•×¨ ×˜×•×•×— ×ª××¨×™×›×™×.";
          return;
        }
        const from = new Date(fromVal + "T00:00:00");
        const to = new Date(toVal + "T00:00:00");
        if(to < from){
          $("adminMsg").textContent = "×˜×•×•×— ×ª××¨×™×›×™× ×œ× ×ª×§×™×Ÿ.";
          return;
        }

        const { rows, totalMs } = await buildReport({from, to, uidOrAll: uid});
        renderReport(rows, totalMs);
        $("adminOk").textContent = `âœ… ×“×•×— ×”×•×¤×§ (${rows.length} ×¨×©×•××•×ª)`;
      }catch(e){
        $("adminMsg").textContent = e.message || String(e);
      }
    };

    $("btnExportCsv").onclick = exportCSV;
    $("btnExportPdf").onclick = exportPDF;

    // âœ… ×—×“×©: ×›×¤×ª×•×¨×™ ×ª×™×§×•×Ÿ
    $("btnLoadFix").onclick = loadFixRecord;
    $("btnSaveFix").onclick = saveFixRecord;
    $("btnClearOut").onclick = clearOutTime;

    // ===== Auth State =====
    onAuthStateChanged(auth, async (user) => {
      $("loginMsg").textContent = "";
      $("empMsg").textContent = "";
      $("empOk").textContent = "";
      $("adminMsg").textContent = "";
      $("adminOk").textContent = "";
      $("usersMsg").textContent = "";
      $("usersOk").textContent = "";
      $("fixMsg").textContent = "";
      $("fixOk").textContent = "";

      if(!user){
        setMode("login");
        return;
      }

      try{
        const profile = await ensureProfile(user);

        if(profile.status === "disabled" && !isAdminEmail(user.email)){
          await signOut(auth);
          $("loginMsg").textContent = "×”××©×ª××© ××•×©×‘×ª. ×¤× ×” ×œ×× ×”×œ.";
          setMode("login");
          return;
        }

        if(profile.role === "admin"){
          setMode("admin");
          setDefaultDates();
          await loadAllUsers();
          showUsersTab();
        } else {
          setMode("employee");
          await refreshEmployeeUI(user, profile);
        }
      }catch(e){
        $("loginMsg").textContent = e.message || String(e);
        setMode("login");
      }
    });

    // ×©××™×¨×” ××•×˜×•××˜×™×ª ×©×× ×”×œ ×ª××™×“ admin ×œ×¤×™ ××™×™×œ
    onAuthStateChanged(auth, async (user) => {
      if(!user) return;
      if(isAdminEmail(user.email)){
        const uref = doc(db, "users", user.uid);
        const snap = await getDoc(uref);
        if(snap.exists()){
          const d = snap.data();
          if(d.role !== "admin"){
            await updateDoc(uref, { role:"admin", updatedAt: serverTimestamp() });
          }
        }
      }
    });
  </script>
</body>
</html>
